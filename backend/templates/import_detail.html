{% extends "base.html" %}

{% block title %}Import Job - SpotiTransFair{% endblock %}

{% block content %}
<div class="page-header d-print-none">
  <div class="container-xl">
    <div class="row g-2 align-items-center">
      <div class="col">
        <div class="page-pretitle">Import Job</div>
        <h2 class="page-title">
          {{ job.source_playlist_name or job.source_playlist_id }}
        </h2>
      </div>
      <div class="col-auto">
        <span class="badge bg-secondary text-uppercase">{{ job.status }}</span>
      </div>
    </div>
  </div>
</div>
<div class="page-body">
    <div class="container-xl">

    <!-- Progress Stats -->
    <div class="card mb-3">
        <div class="card-body">
            <h3 class="card-title">Progress</h3>

            {% set total = stats.total %}
            {% set p_matched = (stats.matched / total * 100) if total > 0 else 0 %}
            {% set p_uncertain = (stats.uncertain / total * 100) if total > 0 else 0 %}
            {% set p_failed = (stats.failed / total * 100) if total > 0 else 0 %}
            {% set p_skipped = (stats.skipped / total * 100) if total > 0 else 0 %}

            <div class="progress progress-xl">
                <div class="progress-bar bg-success" style="width: {{ p_matched }}%" role="progressbar" title="Matched: {{ stats.matched }}"></div>
                <div class="progress-bar bg-warning" style="width: {{ p_uncertain }}%" role="progressbar" title="Uncertain: {{ stats.uncertain }}"></div>
                <div class="progress-bar bg-danger" style="width: {{ p_failed }}%" role="progressbar" title="Failed: {{ stats.failed }}"></div>
                <div class="progress-bar bg-secondary" style="width: {{ p_skipped }}%" role="progressbar" title="Skipped: {{ stats.skipped }}"></div>
            </div>

            <div class="row text-center mt-3">
               <div class="col">
                  <div class="text-secondary">Total</div>
                  <div class="h2">{{ stats.total }}</div>
               </div>
               <div class="col">
                  <div class="text-secondary">Matched</div>
                  <div class="h2 text-success">{{ stats.matched }}</div>
               </div>
               <div class="col">
                  <div class="text-secondary">Uncertain</div>
                  <div class="h2 text-warning">{{ stats.uncertain }}</div>
               </div>
               <div class="col">
                  <div class="text-secondary">Failed</div>
                  <div class="h2 text-danger">{{ stats.failed }}</div>
               </div>
               <div class="col">
                  <div class="text-secondary">Skipped</div>
                  <div class="h2 text-secondary">{{ stats.skipped }}</div>
               </div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="row row-cards mb-3">
      <div class="col-12 col-xl-6">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Item Status Mix</h3>
          </div>
          <div class="card-body">
            <div id="chart-status-mix" style="min-height: 260px;"></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-xl-6">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Top Artists</h3>
          </div>
          <div class="card-body">
            {% if stats.total == 0 %}
              <div class="text-secondary">No items yet.</div>
            {% else %}
              <div id="chart-top-artists" style="min-height: 260px;"></div>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Match Score Distribution</h3>
          </div>
          <div class="card-body">
            <div id="chart-score-distribution" style="min-height: 260px;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="d-flex gap-2 mb-3">
       {% if job.status == 'waiting_review' %}
          <a href="/imports/{{ job.id }}/review" class="btn btn-warning btn-action">
             Review Matches ({{ stats.uncertain }})
          </a>
          <form action="/imports/{{ job.id }}/finalize" method="POST" class="d-inline-block">
             <button type="submit" class="btn btn-success btn-action" onclick="if(!confirm('Finalize import? Uncertain matches will be skipped.')) return false;">
                Finalize Import
             </button>
          </form>
       {% endif %}

       {% if job.target_playlist_id %}
          {% if job.target_provider == 'tidal' %}
            <a href="https://listen.tidal.com/playlist/{{ job.target_playlist_id }}" target="_blank" class="btn btn-primary btn-action">Open in TIDAL</a>
          {% else %}
             <a href="https://music.youtube.com/playlist?list={{ job.target_playlist_id }}" target="_blank" class="btn btn-primary btn-action">Open in YTM</a>
          {% endif %}
       {% endif %}
    </div>

    {% if failed_items or skipped_items %}
    <div class="card mb-3">
       <div class="card-header">
          <h3 class="card-title">Missed Tracks (Failed or Skipped)</h3>
       </div>
       <div class="table-responsive">
          <table class="table card-table table-vcenter text-nowrap datatable">
             <thead>
               <tr>
                 <th>Artist</th>
                 <th>Title</th>
                 <th>Status</th>
               </tr>
             </thead>
             <tbody>
               {% for item in failed_items + skipped_items %}
               <tr>
                  <td>{{ (item.original_track_data.artists|join(', ')) if item.original_track_data.artists is iterable and item.original_track_data.artists is not string else item.original_track_data.artists }}</td>
                  <td>{{ item.original_track_data.name }}</td>
                  <td>
                     {% if item.status.value == 'not_found' %}
                       <span class="badge bg-danger me-1"></span> Not Found
                     {% else %}
                       <span class="badge bg-secondary me-1"></span> Skipped
                     {% endif %}
                  </td>
               </tr>
               {% endfor %}
             </tbody>
          </table>
       </div>
    </div>
    {% endif %}

    {% if job.error_message %}
    <div class="alert alert-danger mt-3">
       {{ job.error_message }}
    </div>
    {% endif %}

  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    var statusOptions = {
      series: {{ status_series|tojson }},
      chart: {
        type: 'donut',
        height: 260,
        fontFamily: 'inherit',
        animations: { enabled: true, easing: 'easeinout', speed: 600 }
      },
      labels: {{ status_labels|tojson }},
      colors: [
        "#2fb344",
        "#f76707",
        "#d63939",
        "#6e7582"
      ],
      legend: { position: 'bottom' }
    };
    new ApexCharts(document.querySelector("#chart-status-mix"), statusOptions).render();

    var topArtistsElement = document.querySelector("#chart-top-artists");
    if (topArtistsElement) {
      var topArtistsOptions = {
        series: [{
          name: 'Tracks',
          data: {{ top_artist_values|tojson }}
        }],
        chart: {
          type: 'bar',
          height: 260,
          fontFamily: 'inherit',
          toolbar: { show: false },
          animations: { enabled: true, easing: 'easeinout', speed: 700 }
        },
        dataLabels: { enabled: false },
        xaxis: { categories: {{ top_artist_labels|tojson }} },
        colors: ["#206bc4"]
      };
      new ApexCharts(topArtistsElement, topArtistsOptions).render();
    }

    var scoreOptions = {
      series: [{
        name: 'Items',
        data: {{ score_values|tojson }}
      }],
      chart: {
        type: 'area',
        height: 260,
        fontFamily: 'inherit',
        toolbar: { show: false },
        animations: { enabled: true, easing: 'easeinout', speed: 700 }
      },
      dataLabels: { enabled: false },
      stroke: { curve: 'smooth', width: 2 },
      fill: { type: 'gradient', gradient: { shadeIntensity: 0.3, opacityFrom: 0.4, opacityTo: 0.05 } },
      xaxis: { categories: {{ score_labels|tojson }} },
      colors: ["#4299e1"]
    };
    new ApexCharts(document.querySelector("#chart-score-distribution"), scoreOptions).render();

    // Loading state for buttons
    const btns = document.querySelectorAll('.btn-action');
    btns.forEach(btn => {
        btn.addEventListener('click', function(e) {
           if (this.target === '_blank') return;
           this.classList.add('disabled');
           this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';
        });
    });
  });
</script>
{% endblock %}
